<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upcoming Events Map</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; /* Prevents scrolling of the body */
        }
        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        #panel {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 75vh; /* Max height */
            background-color: #ffffff;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
            z-index: 2;
            display: flex;
            flex-direction: column;
            transform: translateY(calc(100% - 60px)); /* Start mostly hidden */
            transition: transform 0.3s ease-in-out;
        }
        #panel.open {
            transform: translateY(0);
        }
        #panel-header {
            padding: 10px;
            text-align: center;
            cursor: grab;
            border-bottom: 1px solid #e0e0e0;
        }
        #panel-handle {
            width: 40px;
            height: 5px;
            background-color: #c0c0c0;
            border-radius: 2.5px;
            margin: 0 auto;
        }
        #panel-content {
            overflow-y: auto;
            flex-grow: 1;
            padding: 20px;
        }
        #events-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .card {
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .card-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .card-content {
            padding: 15px;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        .error-message {
            color: #d93025;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="panel">
        <div id="panel-header">
            <div id="panel-handle"></div>
        </div>
        <div id="panel-content">
            <h1>Upcoming Events</h1>
            <div id="events-container"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const panel = document.getElementById('panel');
            const panelHeader = document.getElementById('panel-header');
            let isPanelOpen = false;

            panelHeader.addEventListener('click', () => {
                isPanelOpen = !isPanelOpen;
                panel.classList.toggle('open', isPanelOpen);
            });

            const eventsContainer = document.getElementById('events-container');
            const apiUrl = '/api/events';
            let map;
            let markers = [];

            function initMap() {
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat: 40.7128, lng: -74.0060 }, // Default to NYC
                    zoom: 10,
                });
            }

            fetch(apiUrl)
                .then(response => response.json())
                .then(events => {
                    if (events.length === 0) {
                        eventsContainer.innerHTML = '<p>No upcoming events found.</p>';
                        return;
                    }
                    
                    const bounds = new google.maps.LatLngBounds();

                    events.forEach(event => {
                        const card = createEventCard(event);
                        eventsContainer.appendChild(card);

                        if (event.latitude && event.longitude) {
                            const position = { lat: event.latitude, lng: event.longitude };
                            const marker = new google.maps.Marker({
                                position: position,
                                map: map,
                                title: event.title,
                            });

                            const infowindow = new google.maps.InfoWindow({
                                content: `<strong>${event.title}</strong><br>${event.address}`
                            });

                            marker.addListener('click', () => {
                                infowindow.open({
                                    anchor: marker,
                                    map,
                                });
                            });
                            
                            markers.push(marker);
                            bounds.extend(position);
                        }
                    });

                    if (markers.length > 0) {
                        map.fitBounds(bounds);
                    }
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    eventsContainer.innerHTML = `<p class="error-message">Could not load events.</p>`;
                });

            function createEventCard(event) {
                const card = document.createElement('div');
                card.className = 'card';
                const photoUrl = event.photos && event.photos.length > 0 ? event.photos[0] : 'https://via.placeholder.com/300x150?text=No+Image';
                card.innerHTML = `
                    <img src="${photoUrl}" alt="${event.title}" class="card-img">
                    <div class="card-content">
                        <h2 class="card-title">${event.title}</h2>
                        <p>${new Date(event.start_datetime).toLocaleString()}</p>
                    </div>
                `;
                return card;
            }

            // Load the Google Maps script
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyBA5gWJDCdQIvqWXdtMN6aWJg2h5rLiikU&callback=initMap`;
            script.async = true;
            script.defer = true;
            window.initMap = initMap; // Make initMap globally available
            document.head.appendChild(script);
        });
    </script>

</body>
</html>
