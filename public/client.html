<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Upcoming Garage Sales Map</title>
    <link rel="stylesheet" href="/css/shared.css">
    <link rel="stylesheet" href="/css/client.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007bff">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-title" content="Events Map">
    <style>
        /* 
         * Define CSS variables for safe area insets.
         * These are provided by the browser on devices with notches or home indicators
         * when `viewport-fit=cover` is used in the viewport meta tag.
         */
        :root {
            --safe-area-inset-top: env(safe-area-inset-top, 0px);
            --safe-area-inset-right: env(safe-area-inset-right, 0px);
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-inset-left: env(safe-area-inset-left, 0px);
        }

        /*
         * Apply safe area padding to the main body to avoid system UI.
         * This pushes the entire layout inward to avoid notches or rounded corners.
         */
        body {
            padding-top: var(--safe-area-inset-top);
            padding-left: var(--safe-area-inset-left);
            padding-right: var(--safe-area-inset-right);
        }

        /*
         * Adjust absolutely positioned UI elements to respect the safe areas.
         */
        #center-location-button {
            top: calc(16px + var(--safe-area-inset-top));
            right: calc(10px + var(--safe-area-inset-right));
        }

        /* Apply safe area padding to the fixed bottom navigation bar. */
        #bottom-nav {
            /* Add 5px of padding PLUS the safe area inset. */
            padding-bottom: calc(5px + var(--safe-area-inset-bottom));
            /* Account for left/right safe areas, especially in landscape mode. */
            padding-left: var(--safe-area-inset-left);
            padding-right: var(--safe-area-inset-right);
        }

        /*
         * Hide UI elements that are not needed when running as a standalone PWA.
         * The QR code is not needed if the app is already installed on the device.
         * The install button is also not needed.
         */
        body.standalone-app #qr-code-container,
        body.standalone-app #install-pwa-item {
            display: none;
        }

        .btn-install {
            padding: 8px 16px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            background-color: #007bff;
            color: white;
            transition: background-color 0.2s;
        }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div id="map"></div>
    <div id="debug-overlay"></div>
    <div id="center-location-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <circle cx="12" cy="12" r="3"></circle>
        </svg>
    </div>

    <div id="qr-code-container">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://gapi-3iew.onrender.com"
            alt="QR Code for mobile access">
    </div>
    </div>

    <div id="qr-modal">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=https://gapi-3iew.onrender.com"
            alt="QR Code">
        <p>Scan with your mobile device to open.</p>
    </div>

    <div id="list-panel" class="panel">
        <div class="panel-header">
            <div class="panel-handle"></div>
            <h1 class="panel-title">Upcoming Events</h1>
            <div class="header-actions">
                <button id="refresh-events-btn" class="header-action-btn" title="Refresh events list">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    <span class="header-action-text">Refresh</span>
                </button>
                <button id="add-event-btn" class="header-action-btn" title="Submit a new event">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span class="header-action-text">Add</span>
                </button>
                <button id="settings-btn" class="header-action-btn" title="Settings">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
                    </svg>
                    <span class="header-action-text">Settings</span>
                </button>
                <button id="collapse-button" class="header-action-btn" title="Collapse Panel">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="3" x2="9" y2="21"></line>
                    </svg>
                </button>
            </div>
        </div>
        <div class="panel-content">
            <div id="search-container">
                <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input type="search" id="search-input" placeholder="Search by title or description...">
                <div id="clear-filters-wrapper" style="display: none;">
                    <button id="clear-all-filters-btn" class="clear-filters-btn">Clear All Filters</button>
                </div>
            </div>
            <div class="pills-wrapper">
                <div id="sale-type-pills-container" class="pills-container"></div>
            </div>
            <div class="pills-wrapper">
                <div id="category-pills-container" class="pills-container"></div>
            </div>
            <div id="events-container"></div>
            <button id="scroll-to-top-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="19" x2="12" y2="5"></line>
                    <polyline points="5 12 12 5 19 12"></polyline>
                </svg>
            </button>
        </div>
    </div>
    <div id="expand-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="9" y1="3" x2="9" y2="21"></line>
            <line x1="15" y1="3" x2="15" y2="21"></line>
        </svg>
    </div>

    <nav id="bottom-nav">
        <button id="nav-events-btn" class="nav-btn active" title="Events">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="8" y1="6" x2="21" y2="6"></line>
                <line x1="8" y1="12" x2="21" y2="12"></line>
                <line x1="8" y1="18" x2="21" y2="18"></line>
                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                <line x1="3" y1="18" x2="3.01" y2="18"></line>
            </svg>
            <span class="nav-btn-text">Events</span>
        </button>
        <button id="nav-refresh-btn" class="nav-btn" title="Refresh">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
            </svg>
            <span class="nav-btn-text">Refresh</span>
        </button>
        <button id="nav-add-btn" class="nav-btn" title="Add Event">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="16"></line>
                <line x1="8" y1="12" x2="16" y2="12"></line>
            </svg>
            <span class="nav-btn-text">Add</span>
        </button>
        <button id="nav-settings-btn" class="nav-btn" title="Settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17-.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/>
            </svg>
            <span class="nav-btn-text">Settings</span>
        </button>
    </nav>

    <div id="detail-panel" class="panel" role="dialog" aria-modal="true" aria-labelledby="detail-title"
        aria-hidden="true">
        <div class="panel-header">
            <button id="detail-back-button" aria-label="Close event details" title="Close event details">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <div class="panel-handle"></div>
            <h1 id="detail-title" class="panel-title"></h1>
            <button id="detail-favorite-btn" class="favorite-btn" aria-label="Toggle favorite">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z">
                    </path>
                </svg>
            </button>
        </div>
        <div id="detail-content" class="panel-content"></div>
    </div>

    <div id="submission-modal" class="modal-overlay">
        <div class="modal-content modal-content--layout-flex">
            <h2>Submit a New Event</h2>
            <form id="submission-form">
                <div class="form-scroll-content">
                    <div class="form-group">
                        <label for="event-title">Title</label>
                        <input type="text" id="event-title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="event-description">Description</label>
                        <textarea id="event-description" name="description" rows="3" required maxlength="500"></textarea>
                        <div class="char-counter"><span>0</span> / 500</div>
                    </div>
                    <div class="form-group">
                        <label for="event-address">Address</label>
                        <input type="text" id="event-address" name="address" required
                            placeholder="e.g., 123 Main St, Ottawa, ON">
                    </div>
                    <div class="form-group">
                        <label>Photo (Optional)</label>
                        <div id="photo-upload-group">
                            <div id="photo-preview">
                                <span class="preview-text">Preview</span>
                            </div>
                            <input type="file" id="event-photo" name="photo" accept="image/*">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="event-start">Start Time</label>
                        <input type="datetime-local" id="event-start" name="start_datetime" required>
                    </div>
                    <div class="form-group">
                        <label for="event-end">End Time</label>
                        <input type="datetime-local" id="event-end" name="end_datetime" required>
                    </div>
                    <div class="form-group">
                        <label>Sale Type</label>
                        <div id="event-sale-type-pills" class="pill-select-group"></div>
                        <input type="hidden" id="event-sale-type-hidden" name="sale_type_id" required>
                    </div>
                    <div class="form-group">
                        <label>Item Categories</label>
                        <div id="event-categories-container" class="checkbox-group"></div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancel-submission-btn" class="btn-secondary">Cancel</button>
                    <button type="submit" id="submit-event-btn" class="btn-primary">Submit Event</button>
                </div>
            </form>
        </div>
    </div>

    <div id="report-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Report Event</h2>
            <p>Why are you reporting "<span id="report-event-title"></span>"?</p>
            <form id="report-form">
                <input type="hidden" id="report-event-id" name="eventId">
                <div class="form-group">
                    <div class="radio-group">
                        <label><input type="radio" name="reason" value="inaccurate" required> Inaccurate
                            Information</label>
                        <label><input type="radio" name="reason" value="spam"> Spam or Scam</label>
                        <label><input type="radio" name="reason" value="inappropriate"> Inappropriate Content</label>
                        <label><input type="radio" name="reason" value="cancelled"> Event is not happening/ended</label>
                        <label><input type="radio" name="reason" value="other"> Other (please specify)</label>
                    </div>
                </div>
                <div class="form-group" id="report-details-group" style="display: none;">
                    <label for="report-details">Details</label>
                    <textarea id="report-details" name="details" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancel-report-btn" class="btn-secondary">Cancel</button>
                    <button type="submit" id="submit-report-btn" class="btn-primary"
                        style="background-color: #dc3545; border-color: #dc3545;">Submit Report</button>
                </div>
            </form>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>Settings</h2>
            <div class="settings-content">
                <div id="install-pwa-item" class="settings-item" style="display: none;">
                    <span>Install App to Home Screen</span>
                    <button id="install-pwa-btn" class="btn-install">Install</button>
                </div>
                <div class="settings-item">
                    <label for="clustering-toggle">Cluster Map Pins</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="clustering-toggle" class="toggle-switch-checkbox">
                        <label class="toggle-switch-label" for="clustering-toggle"></label>
                    </div>
                </div>
                <div class="settings-item">
                    <label>Map Type</label>
                    <div class="segmented-control">
                        <input type="radio" id="map-type-roadmap" name="map-type" value="roadmap" checked>
                        <label for="map-type-roadmap">Map</label>
                        <input type="radio" id="map-type-satellite" name="map-type" value="satellite">
                        <label for="map-type-satellite">Satellite</label>
                    </div>
                </div>
                <div class="settings-item">
                    <label for="debug-toggle">Show Debug Info</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="debug-toggle" class="toggle-switch-checkbox">
                        <label class="toggle-switch-label" for="debug-toggle"></label>
                    </div>
                </div>
                <div class="settings-item">
                    <label for="zoom-level-slider">Default Zoom</label>
                    <div class="zoom-control">
                        <input type="range" id="zoom-level-slider" min="10" max="18" step="1">
                        <span id="zoom-level-value">12</span>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" id="close-settings-btn" class="btn-primary">Done</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            /**
             * Checks if the web app is running on a mobile device and/or in standalone "app mode".
             */
            function checkDisplayMode() {
                // 1. Check for standalone "app mode" (PWA installed on home screen)
                const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches;

                // You can use this to apply specific styles or run certain scripts
                if (isInStandaloneMode) {
                    console.log('App is running in standalone mode.');
                    document.body.classList.add('standalone-app');
                } else {
                    console.log('App is running in a browser tab.');
                }

                // 2. A simple check for a mobile device based on user agent
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                console.log(`Is mobile device: ${isMobile}`);
            }
            checkDisplayMode();

            /**
             * Handles the PWA installation prompt.
             */
            let deferredPrompt;
            const installPwaItem = document.getElementById('install-pwa-item');
            const installPwaBtn = document.getElementById('install-pwa-btn');

            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the default browser prompt from showing automatically
                e.preventDefault();
                // Stash the event so it can be triggered later.
                deferredPrompt = e;
                // Show our custom install button in the settings
                if (installPwaItem) {
                    installPwaItem.style.display = 'flex';
                }
            });

            if (installPwaBtn) {
                installPwaBtn.addEventListener('click', async () => {
                    if (!deferredPrompt) return;
                    // Show the browser's installation prompt.
                    deferredPrompt.prompt();
                    // Wait for the user to respond and log their choice.
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to install prompt: ${outcome}`);
                    // The prompt can only be used once, so clear it.
                    deferredPrompt = null;
                    // Hide the install button as it can't be used again.
                    if (installPwaItem) {
                        installPwaItem.style.display = 'none';
                    }
                });
            }

            /**
             * Adds character counting functionality to textareas with a maxlength attribute
             * and a corresponding counter element.
             */
            function setupCharCounters() {
                const textarea = document.getElementById('event-description');
                if (!textarea) return;

                // The counter element is expected to be the next sibling
                const counter = textarea.nextElementSibling;
                if (!counter || !counter.classList.contains('char-counter')) return;

                const countSpan = counter.querySelector('span');
                const maxLength = parseInt(textarea.getAttribute('maxlength'), 10);

                if (!countSpan || isNaN(maxLength)) return;

                textarea.addEventListener('input', () => {
                    const currentLength = textarea.value.length;
                    countSpan.textContent = currentLength;

                    counter.classList.remove('warning', 'error');
                    if (currentLength > maxLength) {
                        counter.classList.add('error');
                    } else if (currentLength > maxLength * 0.9) {
                        counter.classList.add('warning');
                    }
                });
            }

            /**
             * Persists submission form data to localStorage to prevent data loss on accidental close.
             */
            function setupFormPersistence() {
                const submissionForm = document.getElementById('submission-form');
                if (!submissionForm) return;

                const submissionModal = document.getElementById('submission-modal');
                if (submissionModal) {
                    submissionModal.addEventListener('click', (e) => {
                        // Prevent the submission modal from closing when the overlay is clicked.
                        // This is a specific override because this form has data persistence,
                        // and we don't want users to accidentally lose their input.
                        if (e.target === submissionModal) {
                            e.stopImmediatePropagation();
                        }
                    }, true); // Use capture phase to run before any generic modal-closing handlers.
                }

                const addEventDesktopBtn = document.getElementById('add-event-btn');
                const addEventMobileBtn = document.getElementById('nav-add-btn');
                const cancelSubmissionBtn = document.getElementById('cancel-submission-btn');
                const FORM_STORAGE_KEY = 'unsavedSubmissionFormData';

                const saveFormData = () => {
                    const formData = new FormData(submissionForm);
                    const data = {};
                    // Handle all single-value fields
                    for (const key of formData.keys()) {
                        if (!key.endsWith('[]')) {
                            data[key] = formData.get(key);
                        }
                    }
                    // Handle multi-value fields (checkboxes)
                    data['category_ids[]'] = formData.getAll('category_ids[]');
                    
                    // Don't save the file itself for security reasons
                    delete data.photo;

                    localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(data));
                };

                const loadFormData = () => {
                    const savedDataJSON = localStorage.getItem(FORM_STORAGE_KEY);
                    if (!savedDataJSON) return;

                    try {
                        const data = JSON.parse(savedDataJSON);
                        console.log('Restoring form data from localStorage.');

                        // Restore standard inputs
                        for (const key in data) {
                            if (key.endsWith('[]')) continue; // Handle checkboxes separately
                            const element = submissionForm.querySelector(`[name="${key}"]`);
                            if (element) {
                                element.value = data[key];
                            }
                        }

                        // Restore sale type pill by simulating a click
                        const saleTypeId = data['sale_type_id'];
                        if (saleTypeId) {
                            const pill = document.querySelector(`#event-sale-type-pills .filter-pill[data-id="${saleTypeId}"]`);
                            pill?.click();
                        }

                        // Restore category checkboxes
                        const categoryIds = data['category_ids[]'] || [];
                        submissionForm.querySelectorAll('input[name="category_ids[]"]').forEach(cb => {
                            cb.checked = categoryIds.includes(cb.value);
                        });

                        // Manually trigger an input event on the textarea to update the counter
                        submissionForm.querySelector('#event-description')?.dispatchEvent(new Event('input', { bubbles: true }));

                    } catch (error) {
                        console.error('Failed to load form data:', error);
                        localStorage.removeItem(FORM_STORAGE_KEY); // Clear corrupted data
                    }
                };

                const clearFormData = () => localStorage.removeItem(FORM_STORAGE_KEY);

                submissionForm.addEventListener('input', saveFormData);
                submissionForm.addEventListener('submit', () => setTimeout(clearFormData, 500));
                [addEventDesktopBtn, addEventMobileBtn].forEach(btn => btn?.addEventListener('click', loadFormData));
                cancelSubmissionBtn?.addEventListener('click', (e) => {
                    if (localStorage.getItem(FORM_STORAGE_KEY)) {
                        if (confirm('Are you sure you want to discard your changes?')) {
                            clearFormData();
                        } else {
                            e.preventDefault();
                            e.stopImmediatePropagation();
                        }
                    }
                }, true); // Use capture phase to run before other modal-closing listeners
            }
            setupCharCounters();
            setupFormPersistence();
        });
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
    <script src="/markercluster.js" defer></script>
    <script src="/client.js" defer></script>
</body>


</html>